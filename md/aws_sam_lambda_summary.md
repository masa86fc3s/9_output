# AWS SAM × Lambda × S3 × DynamoDB 開発まとめ

## 1️⃣ ここまでやってきたこと

### インフラ構築
- **AWS SAM/CloudFormation** で IaC テンプレートを作成  
  - S3 バケット、DynamoDB テーブル、2つの Lambda 関数を一括デプロイ  
  - Lambda 関数ごとに IAM ロールを分離して最低限の権限を付与

### アプリコード
- **`saas_fetch.py`**  
  - SaaS（ダミー API）からデータを取得し S3 にアップロード
- **`app.py`**  
  - S3 の PUT イベントをトリガーに DynamoDB へデータ保存

### 全体フロー
```
SaaS API → Lambda (saas_fetch.py) → S3 → Lambda (app.py) → DynamoDB
```

## 2️⃣ 工夫したこと

| 工夫ポイント | 具体的内容 |
|-------------|-----------|
| **イベント駆動設計** | SaaSデータ取得→S3保存→S3イベント→DynamoDB保存と、フルマネージドなイベント連鎖を採用。 |
| **IaC化** | すべてをCloudFormation/SAMでコード化し、再現可能な環境を構築。 |
| **ローカルデバッグ** | `sam local invoke` を活用して、S3イベントのJSONを手元で模擬しながら動作確認。 |
| **権限最小化** | LambdaごとにIAMロールを分けてS3 GetObject / DynamoDB PutItem など最小権限で設計。 |

## 3️⃣ うまくいかなかったことと対応

| つまずいた点 | 対応・学び |
|--------------|----------|
| **`sam` コマンドが見つからない** | PATH が通っていなかった。`npm install -g aws-sam-cli` または公式インストーラで解決。 |
| **CloudFormation のパラメータエラー** | テンプレートの `Default` 値や必須パラメータを見直し。Stack 起動時に明示的にパラメータを指定して解決。 |
| **S3 → Lambda のイベント通知が発火しない** | バケット通知設定（`NotificationConfiguration`）と Lambda の権限を再確認して修正。 |
| **CSV の読み込み/文字コード** | UTF-8/BOM の差異で DynamoDB への書き込みがエラーに。Python 側で `encoding='utf-8-sig'` を指定して解決。 |

## 4️⃣ 学び・今後に活かせる点
- **イベントドリブン設計の強力さ**：バッチ処理ではなく、S3イベントを使うことでサーバレスかつリアルタイムにデータ連携できる。  
- **SAM を使った IaC**：リソースをコード化することで、環境差異のない再デプロイが容易に。  
- **最小権限設計**：不要な権限を付けないことでセキュリティ向上。

## まとめ
今回のプロジェクトでは  
**「SaaS → S3 → DynamoDB への自動連携」**を  
**AWS SAM + Lambda + S3 イベント**で構築し、  
設計・実装・トラブルシュートを一通り経験できました。  

この一連の流れを理解したことで、
- 今後のデータパイプライン設計
- サーバレスアーキテクチャの応用
- IaCでの再現性確保  
といった実務にそのまま活かせる知識が得られています。
